name: Build and Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build:
        runs-on: macos-14

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Build app (Apple Silicon)
              run: |
                  xcodebuild -scheme LaunchX \
                    -configuration Release \
                    -arch arm64 \
                    -archivePath $PWD/build/LaunchX.xcarchive \
                    archive \
                    ONLY_ACTIVE_ARCH=NO \
                    CODE_SIGN_IDENTITY="-" \
                    CODE_SIGNING_REQUIRED=NO \
                    CODE_SIGNING_ALLOWED=NO

            - name: Export app
              run: |
                  mkdir -p build/export
                  cp -R build/LaunchX.xcarchive/Products/Applications/LaunchX.app build/export/

            - name: Create DMG
              run: |
                  # Install create-dmg
                  brew install create-dmg

                  # Create DMG
                  create-dmg \
                    --volname "LaunchX" \
                    --window-pos 200 120 \
                    --window-size 600 400 \
                    --icon-size 100 \
                    --icon "LaunchX.app" 150 185 \
                    --hide-extension "LaunchX.app" \
                    --app-drop-link 450 185 \
                    "build/LaunchX-${{ github.ref_name }}-arm64.dmg" \
                    "build/export/" || true

                  # Fallback: create simple DMG if create-dmg fails
                  if [ ! -f "build/LaunchX-${{ github.ref_name }}-arm64.dmg" ]; then
                    hdiutil create -volname "LaunchX" -srcfolder "build/export" -ov -format UDZO "build/LaunchX-${{ github.ref_name }}-arm64.dmg"
                  fi

            - name: Create ZIP
              run: |
                  cd build/export
                  zip -r ../LaunchX-${{ github.ref_name }}-arm64.zip LaunchX.app

            - name: Generate release notes
              id: release_notes
              run: |
                  VERSION="${{ github.ref_name }}"
                  CHANGELOG=""

                  # 尝试从 CHANGELOG.md 提取当前版本的更新内容
                  if [ -f "CHANGELOG.md" ]; then
                    # 提取当前版本的更新日志（从 ## vX.X.X 到下一个 ## v 之间的内容）
                    CHANGELOG=$(sed -n "/^## ${VERSION}/,/^## v/p" CHANGELOG.md | sed '$d')
                  fi

                  echo "notes<<EOF" >> $GITHUB_OUTPUT

                  # 如果有 CHANGELOG 内容则使用，否则使用默认标题
                  if [ -n "$CHANGELOG" ]; then
                    echo "$CHANGELOG" >> $GITHUB_OUTPUT
                  else
                    echo "## LaunchX ${VERSION}" >> $GITHUB_OUTPUT
                  fi

                  echo "" >> $GITHUB_OUTPUT
                  echo "---" >> $GITHUB_OUTPUT
                  echo "" >> $GITHUB_OUTPUT
                  echo "### 安装说明" >> $GITHUB_OUTPUT
                  echo "1. 下载 \`LaunchX-${VERSION}-arm64.dmg\` 或 \`LaunchX-${VERSION}-arm64.zip\`" >> $GITHUB_OUTPUT
                  echo "2. 打开 DMG 并将 LaunchX 拖入 Applications，或解压 ZIP 后移动到 Applications" >> $GITHUB_OUTPUT
                  echo "3. 启动 LaunchX 并授予必要的权限" >> $GITHUB_OUTPUT
                  echo "4. 使用 \`Option + Space\` 激活搜索" >> $GITHUB_OUTPUT
                  echo "" >> $GITHUB_OUTPUT
                  echo "### 系统要求" >> $GITHUB_OUTPUT
                  echo "- macOS 13.0 或更高版本" >> $GITHUB_OUTPUT
                  echo "- Apple Silicon (M1/M2/M3/M4)" >> $GITHUB_OUTPUT
                  echo "" >> $GITHUB_OUTPUT
                  echo "> ⚠️ 本版本仅支持 Apple Silicon Mac，不支持 Intel Mac" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: LaunchX ${{ github.ref_name }}
                  body: ${{ steps.release_notes.outputs.notes }}
                  draft: false
                  prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') }}
                  files: |
                      build/LaunchX-${{ github.ref_name }}-arm64.dmg
                      build/LaunchX-${{ github.ref_name }}-arm64.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
